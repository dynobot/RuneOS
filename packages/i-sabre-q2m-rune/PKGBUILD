# Maintainer: gearhead
# Contributor:

pkgname=i-sabre-q2m-rune
_pkgname=I-Sabre_9038Q2M
pkgver=0.r5.4accda5
pkgrel=1
pkgdesc="i-sabre-q2m kernel module"
url="https://github.com/audiophonics/I-Sabre_9038Q2M"
arch=('armv6h' 'armv7h')
license=('GPLv2')
depends=('linux')
makedepends=('linux-headers' 'git')
#provides=('i-sabre-q2m.ko.gz')
#conflicts=('i-sabre-q2m.ko.gz')
	
source=("$_pkgname::git+https://github.com/audiophonics/I-Sabre_9038Q2M")
sha256sums=('SKIP')

_extramodules="$(basename $(readlink -f /lib/modules/$(uname -r)/extramodules/))"

pkgver() {
  cd "$_pkgname"
  printf "0.r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "${srcdir}"/"$_pkgname"
msg2 "Renamimg codec to match module"
  # use sed and mv to change the codec name from i-sabre-codec to i-sabre-q2m-codec
  mv i-sabre-codec.h i-sabre-q2m-codec.h
  mv i-sabre-codec.c i-sabre-q2m-codec.c
  find ./ -type f -exec sed -i 's/i-sabre-codec/i-sabre-q2m-codec/g' {} \;
msg2 "modifying Makefile for ARCH"
  sed -i '1 s/source/build/g' Makefile
  sed -i 's/.ko/.ko.gz/g' Makefile
}

build() {
  cd "${srcdir}"/"$_pkgname"
msg2 "Making modules"
  make
msg2 "Making overlay"
  make dtbs
msg2 "gzip-ing modules"
  gzip -9 *.ko
}
	
package() {
  _kernver=$(pacman -Q linux | sed -r 's#.* ([0-9]+\.[0-9]+).*#\1#')
  #depends=("linux>=$_kernver" "linux<${_kernver/.*}.$(expr ${_kernver/*.} + 1)")
  #KERNEL_VERSION=$(cat /usr/lib/modules/extramodules-$_kernver-ARCH/version)
  #msg "Kernel = $KERNEL_VERSION"

  cd "$srcdir"/"$_pkgname"
msg2 "in src dir, next is modules_install"
  # make DESTDIR="${pkgdir}/" modules_install
  # copy systemd files
  install -Dm 644 "$srcdir/$_pkgname/i-sabre-q2m.ko.gz" \
	"$pkgdir/usr/lib/modules/extramodules-$_kernver-raspberrypi/i-sabre-q2m.ko.gz"
  install -Dm 644 "$srcdir/$_pkgname/i-sabre-q2m-codec.ko.gz" \
	"$pkgdir/usr/lib/modules/extramodules-$_kernver-raspberrypi/i-sabre-q2m-codec.ko.gz"
  install -Dm 644 "$srcdir/$_pkgname/i-sabre-q2m.dtbo" \
	"$pkgdir/boot/overlays/i-sabre-q2m.dtbo"
}
